{"version":3,"file":"internal.js","sourceRoot":"","sources":["../../../src/file-input/internal.tsx"],"names":[],"mappings":"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","sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nimport React, { ChangeEvent, Ref, useEffect, useRef, useState } from 'react';\nimport clsx from 'clsx';\n\nimport { useMergeRefs, useUniqueId, warnOnce } from '@cloudscape-design/component-toolkit/internal';\nimport { useSingleTabStopNavigation } from '@cloudscape-design/component-toolkit/internal';\nimport {\n  GeneratedAnalyticsMetadataFragment,\n  getAnalyticsMetadataAttribute,\n} from '@cloudscape-design/component-toolkit/internal/analytics-metadata';\n\nimport InternalButton from '../button/internal';\nimport { useFormFieldContext } from '../contexts/form-field';\nimport { getBaseProps } from '../internal/base-component/index.js';\nimport ScreenreaderOnly from '../internal/components/screenreader-only';\nimport { fireNonCancelableEvent } from '../internal/events';\nimport checkControlled from '../internal/hooks/check-controlled';\nimport useForwardFocus from '../internal/hooks/forward-focus';\nimport { InternalBaseComponentProps } from '../internal/hooks/use-base-component/index.js';\nimport { joinStrings } from '../internal/utils/strings';\nimport { GeneratedAnalyticsMetadataFileInputComponent } from './analytics-metadata/interfaces';\nimport { FileInputProps } from './interfaces';\n\nimport styles from './styles.css.js';\n\ninterface InternalFileInputProps {\n  __inputClassName?: string;\n  __inputNativeAttributes?: React.InputHTMLAttributes<HTMLInputElement> | Record<`data-${string}`, string>;\n  __injectAnalyticsComponentMetadata?: boolean;\n}\n\nconst InternalFileInput = React.forwardRef(\n  (\n    {\n      accept,\n      ariaRequired,\n      ariaLabel,\n      multiple = false,\n      value,\n      onChange,\n      variant = 'button',\n      children,\n      __internalRootRef,\n      __inputClassName,\n      __inputNativeAttributes,\n      __injectAnalyticsComponentMetadata,\n      ...restProps\n    }: FileInputProps & InternalBaseComponentProps & InternalFileInputProps,\n    ref: Ref<FileInputProps.Ref>\n  ) => {\n    const baseProps = getBaseProps(restProps);\n    const uploadInputRef = useRef<HTMLInputElement>(null);\n    const containerRef = useRef<HTMLButtonElement>(null);\n    const mergedRef = useMergeRefs(__internalRootRef, containerRef);\n\n    const uploadButtonLabelId = useUniqueId('upload-button-label');\n    const formFieldContext = useFormFieldContext(restProps);\n    const selfControlId = useUniqueId('upload-input');\n    const controlId = formFieldContext.controlId ?? selfControlId;\n\n    useForwardFocus(ref, uploadInputRef);\n\n    const [isFocused, setIsFocused] = useState(false);\n    const onUploadButtonClick = () => uploadInputRef.current?.click();\n    const onUploadInputFocus = () => {\n      setIsFocused(true);\n    };\n    const onUploadInputBlur = () => setIsFocused(false);\n\n    const onUploadInputChange = ({ target }: ChangeEvent<HTMLInputElement>) => {\n      fireNonCancelableEvent(onChange, { value: target.files ? Array.from(target.files) : [] });\n    };\n\n    checkControlled('FileInput', 'value', value, 'onChange', onChange);\n\n    const nativeAttributes: React.HTMLAttributes<HTMLInputElement> = {\n      'aria-label': ariaLabel || children,\n      'aria-labelledby': joinStrings(formFieldContext.ariaLabelledby, uploadButtonLabelId),\n      'aria-describedby': formFieldContext.ariaDescribedby,\n      ...__inputNativeAttributes,\n    };\n    if (formFieldContext.invalid) {\n      nativeAttributes['aria-invalid'] = true;\n    }\n    if (ariaRequired) {\n      nativeAttributes['aria-required'] = true;\n    }\n\n    if (variant === 'icon' && !ariaLabel) {\n      warnOnce('FileInput', 'Aria label is required with icon variant.');\n    }\n\n    // Synchronizing component's value with the native file input state.\n    useEffect(() => {\n      /* istanbul ignore next: The DataTransfer is not available in jsdom. */\n      if (window.DataTransfer) {\n        const dataTransfer = new DataTransfer();\n        for (const file of value) {\n          dataTransfer.items.add(file);\n        }\n        uploadInputRef.current!.files = dataTransfer.files;\n      }\n      if (uploadInputRef.current) {\n        uploadInputRef.current.value = ''; // reset value to allow calling onChange when the same file is uploaded again\n      }\n    }, [value]);\n\n    const { tabIndex } = useSingleTabStopNavigation(uploadInputRef);\n\n    const analyticsLabel = variant === 'button' && children ? 'button' : 'input';\n    const componentAnalyticsMetadata: GeneratedAnalyticsMetadataFileInputComponent = {\n      name: 'awsui.FileInput',\n      label: analyticsLabel,\n    };\n\n    const analyticsMetadata: GeneratedAnalyticsMetadataFragment = { detail: { label: analyticsLabel } };\n    if (__injectAnalyticsComponentMetadata) {\n      analyticsMetadata.component = componentAnalyticsMetadata;\n    }\n\n    return (\n      <div\n        {...baseProps}\n        ref={mergedRef}\n        className={clsx(baseProps.className, styles.root)}\n        {...getAnalyticsMetadataAttribute(analyticsMetadata)}\n      >\n        {/* This is the actual interactive and accessible file-upload element. */}\n        {/* It is visually hidden to achieve the desired UX design. */}\n        <input\n          id={controlId}\n          ref={uploadInputRef}\n          type=\"file\"\n          hidden={false}\n          multiple={multiple}\n          accept={accept}\n          onChange={onUploadInputChange}\n          onFocus={onUploadInputFocus}\n          onBlur={onUploadInputBlur}\n          className={clsx(styles['file-input'], styles.hidden, __inputClassName)}\n          tabIndex={tabIndex}\n          {...nativeAttributes}\n        />\n\n        {/* The button is decorative. It dispatches clicks to the file input and is ARIA-hidden. */}\n        {/* When the input is focused the focus outline is forced on the button. */}\n        <InternalButton\n          iconName=\"upload\"\n          variant={variant === 'icon' ? 'icon' : undefined}\n          formAction=\"none\"\n          onClick={onUploadButtonClick}\n          className={clsx(styles['file-input-button'], {\n            [styles['force-focus-outline-button']]: isFocused && variant === 'button',\n            [styles['force-focus-outline-icon']]: isFocused && variant === 'icon',\n          })}\n          nativeButtonAttributes={{ tabIndex: -1, 'aria-hidden': true }}\n          __skipNativeAttributesWarnings={true}\n        >\n          {variant === 'button' && children}\n        </InternalButton>\n\n        {/* The file input needs to be labelled with provided content. Can't use the button because it is ARIA-hidden. */}\n        <ScreenreaderOnly id={uploadButtonLabelId}>{ariaLabel || children}</ScreenreaderOnly>\n      </div>\n    );\n  }\n);\n\nexport default InternalFileInput;\n"]}