{"version":3,"file":"use-group-selection.js","sourceRoot":"","sources":["../../../../src/table/selection/use-group-selection.ts"],"names":[],"mappings":"AAAA,qEAAqE;AACrE,sCAAsC;AACtC,OAAO,EAAE,QAAQ,EAAE,MAAM,OAAO,CAAC;AAEjC,OAAO,EAAE,aAAa,EAAE,WAAW,EAAE,MAAM,+CAA+C,CAAC;AAE3F,OAAO,EAAE,sBAAsB,EAAE,MAAM,uBAAuB,CAAC;AAC/D,OAAO,EAAE,WAAW,EAAE,MAAM,8BAA8B,CAAC;AAG3D,OAAO,EAAE,iBAAiB,EAAE,MAAM,UAAU,CAAC;AAa7C,MAAM,UAAU,iBAAiB,CAAI,EACnC,UAAU,EACV,KAAK,EACL,SAAS,EACT,aAAa,GAAG,EAAE,EAClB,eAAe,EACf,OAAO,EACP,cAAc,EACd,aAAa,EACb,gBAAgB,EAChB,iBAAiB,GACG;IACpB,uEAAuE;IACvE,MAAM,oBAAoB,GAAG,WAAW,EAAE,CAAC;IAC3C,MAAM,CAAC,YAAY,EAAE,eAAe,CAAC,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC;IACxD,MAAM,CAAC,eAAe,EAAE,kBAAkB,CAAC,GAAG,QAAQ,CAAW,IAAI,CAAC,CAAC;IAEvE,IAAI,aAAa,KAAK,OAAO,EAAE,CAAC;QAC9B,OAAO,EAAE,cAAc,EAAE,GAAG,EAAE,CAAC,KAAK,EAAE,CAAC;IACzC,CAAC;IAED,MAAM,SAAS,GAAG,CAAC,IAAO,EAAE,EAAE,CAAC,cAAc,CAAC,sBAAsB,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC;IAClF,MAAM,WAAW,GAAG,CAAC,IAAO,EAAE,EAAE,CAAC,cAAc,CAAC,sBAAsB,CAAC,IAAI,CAAC,CAAC,QAAQ,CAAC;IACtF,MAAM,sBAAsB,GAAG,CAAC,IAAO,EAAE,EAAE;QACzC,MAAM,EAAE,UAAU,EAAE,kBAAkB,EAAE,GAAG,cAAc,CAAC,sBAAsB,CAAC,IAAI,CAAC,CAAC;QACvF,OAAO,EAAE,UAAU,EAAE,kBAAkB,EAAE,CAAC;IAC5C,CAAC,CAAC;IACF,MAAM,UAAU,GAAG,CAAC,IAAc,EAAE,EAAE,CAAC,CAAC,gBAAgB,IAAI,gBAAgB,CAAC,IAAI,CAAC,KAAK,UAAU,CAAC;IAClG,MAAM,SAAS,GAAG,EAAE,SAAS,EAAE,OAAO,EAAE,WAAW,EAAE,UAAU,EAAE,CAAC;IAClE,MAAM,aAAa,GAAG,IAAI,aAAa,CAAC,SAAS,EAAE,SAAS,EAAE,cAAc,CAAC,cAAc,CAAC,CAAC;IAC7F,MAAM,QAAQ,GAAG,CAAC,cAAiD,EAAE,EAAE;QACrE,sBAAsB,CAAC,cAAc,CAAC,sBAAsB,EAAE,EAAE,cAAc,EAAE,CAAC,CAAC;QAClF,iBAAiB,aAAjB,iBAAiB,uBAAjB,iBAAiB,CAAG,WAAW,CAAC,CAAC;IACnC,CAAC,CAAC;IAEF,2BAA2B;IAC3B,MAAM,cAAc,GAAG,IAAI,GAAG,EAAa,CAAC;IAC5C,KAAK,CAAC,OAAO,CAAC,CAAC,IAAI,EAAE,CAAC,EAAE,EAAE,CAAC,cAAc,CAAC,GAAG,CAAC,iBAAiB,CAAC,OAAO,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;IACpF,MAAM,qBAAqB,GAAG,CAAC,IAAO,EAAO,EAAE;QAC7C,MAAM,oBAAoB,GAAG,eAAe;YAC1C,CAAC,CAAC,cAAc,CAAC,GAAG,CAAC,iBAAiB,CAAC,OAAO,EAAE,eAAe,CAAC,CAAC;YACjE,CAAC,CAAC,SAAS,CAAC;QACd,2EAA2E;QAC3E,sFAAsF;QACtF,IAAI,oBAAoB,KAAK,SAAS,EAAE,CAAC;YACvC,MAAM,gBAAgB,GAAG,cAAc,CAAC,GAAG,CAAC,iBAAiB,CAAC,OAAO,EAAE,IAAI,CAAC,CAAE,CAAC;YAC/E,MAAM,KAAK,GAAG,IAAI,CAAC,GAAG,CAAC,gBAAgB,EAAE,oBAAoB,CAAC,CAAC;YAC/D,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,gBAAgB,EAAE,oBAAoB,CAAC,CAAC;YAC7D,MAAM,cAAc,GAAG,KAAK,CAAC,KAAK,CAAC,KAAK,EAAE,GAAG,GAAG,CAAC,CAAC,CAAC;YACnD,OAAO,oBAAoB,GAAG,gBAAgB,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC,CAAC,cAAc,CAAC,OAAO,EAAE,CAAC;QAC7F,CAAC;QACD,OAAO,CAAC,IAAI,CAAC,CAAC;IAChB,CAAC,CAAC;IAEF,MAAM,eAAe,GAAG,GAAG,EAAE,CAAC,QAAQ,CAAC,aAAa,CAAC,SAAS,EAAE,CAAC,QAAQ,EAAE,CAAC,CAAC;IAE7E,MAAM,gBAAgB,GAAG,CAAC,IAAO,EAAE,EAAE;QACnC,kBAAkB,CAAC,IAAI,CAAC,CAAC;QACzB,MAAM,cAAc,GAAG,YAAY,CAAC,CAAC,CAAC,qBAAqB,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;QAC3E,MAAM,oBAAoB,GAAG,cAAc,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,IAAI,EAAE,EAAE,CAAC,GAAG,CAAC,GAAG,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,EAAE,IAAI,GAAG,EAAY,CAAC,CAAC;QACjH,iEAAiE;QACjE,IAAI,oBAAoB,CAAC,IAAI,KAAK,CAAC,EAAE,CAAC;YACpC,QAAQ,CAAC,aAAa,CAAC,UAAU,CAAC,cAAc,CAAC,CAAC,QAAQ,EAAE,CAAC,CAAC;QAChE,CAAC;IACH,CAAC,CAAC;IAEF,MAAM,wBAAwB,GAAG,CAAC,IAAc,EAAE,EAAE,CAAC,GAAG,EAAE,CACxD,QAAQ,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,aAAa,CAAC,SAAS,EAAE,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC,aAAa,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,QAAQ,EAAE,CAAC,CAAC;IAEpG,OAAO;QACL,cAAc,EAAE,aAAa,CAAC,cAAc;QAC5C,iBAAiB,EAAE,GAAG,EAAE;;YAAC,OAAA,CAAC;gBACxB,IAAI,EAAE,oBAAoB;gBAC1B,aAAa,EAAE,OAAO;gBACtB,QAAQ,EAAE,KAAK;gBACf,OAAO,EAAE,aAAa,CAAC,kBAAkB,EAAE;gBAC3C,aAAa,EAAE,aAAa,CAAC,uBAAuB,EAAE;gBACtD,QAAQ,EAAE,eAAe;gBACzB,SAAS,EAAE,WAAW,CACpB,UAAU,aAAV,UAAU,uBAAV,UAAU,CAAE,mBAAmB,EAC/B,MAAA,UAAU,aAAV,UAAU,uBAAV,UAAU,CAAE,sBAAsB,2DAAG;oBACnC,aAAa;oBACb,UAAU,EAAE,MAAA,cAAc,CAAC,eAAe,mCAAI,eAAe;oBAC7D,kBAAkB,EAAE,MAAA,cAAc,CAAC,uBAAuB,mCAAI,aAAa,CAAC,MAAM;iBACnF,CAAC,CACH;aACF,CAAC,CAAA;SAAA;QACF,qBAAqB,EAAE,IAAI,CAAC,EAAE;;YAAC,OAAA,CAAC;gBAC9B,IAAI,EAAE,oBAAoB;gBAC1B,aAAa,EAAE,OAAO;gBACtB,QAAQ,EAAE,KAAK;gBACf,OAAO,EAAE,aAAa,CAAC,cAAc,CAAC,IAAI,CAAC;gBAC3C,aAAa,EAAE,aAAa,CAAC,mBAAmB,CAAC,IAAI,CAAC;gBACtD,QAAQ,EAAE,GAAG,EAAE,CAAC,gBAAgB,CAAC,IAAI,CAAC;gBACtC,aAAa,EAAE,KAAK,CAAC,EAAE,CAAC,eAAe,CAAC,KAAK,CAAC;gBAC9C,SAAS,EAAE,WAAW,CACpB,UAAU,aAAV,UAAU,uBAAV,UAAU,CAAE,mBAAmB,EAC/B,MAAA,UAAU,aAAV,UAAU,uBAAV,UAAU,CAAE,kBAAkB,2DAAG,EAAE,aAAa,EAAE,GAAG,sBAAsB,CAAC,IAAI,CAAC,EAAE,EAAE,IAAI,CAAC,CAC3F;aACF,CAAC,CAAA;SAAA;QACF,uBAAuB,EAAE,IAAI,CAAC,EAAE;;YAAC,OAAA,CAAC;gBAChC,IAAI,EAAE,oBAAoB;gBAC1B,aAAa,EAAE,OAAO;gBACtB,QAAQ,EAAE,KAAK;gBACf,OAAO,EAAE,IAAI,CAAC,CAAC,CAAC,aAAa,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC,QAAQ;gBACtF,aAAa,EAAE,KAAK;gBACpB,QAAQ,EAAE,wBAAwB,CAAC,IAAI,CAAC;gBACxC,SAAS,EAAE,WAAW,CACpB,UAAU,aAAV,UAAU,uBAAV,UAAU,CAAE,mBAAmB,EAC/B,MAAA,UAAU,aAAV,UAAU,uBAAV,UAAU,CAAE,wBAAwB,2DAAG,EAAE,aAAa,EAAE,EAAE,IAAI,CAAC,CAChE;aACF,CAAC,CAAA;SAAA;KACH,CAAC;AACJ,CAAC","sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { useState } from 'react';\n\nimport { SelectionTree, useUniqueId } from '@cloudscape-design/component-toolkit/internal';\n\nimport { fireNonCancelableEvent } from '../../internal/events';\nimport { joinStrings } from '../../internal/utils/strings';\nimport { InternalExpandableRowsProps } from '../expandable-rows/expandable-rows-utils';\nimport { InternalSelectionType, TableProps } from '../interfaces';\nimport { getTrackableValue } from '../utils';\nimport { SelectionProps } from './interfaces';\n\ntype SelectionOptions<T> = Pick<\n  TableProps<T>,\n  'ariaLabels' | 'items' | 'trackBy' | 'getLoadingStatus' | 'selectedItems' | 'totalItemsCount'\n> & {\n  rootItems: readonly T[];\n  selectionType?: InternalSelectionType;\n  expandableRows: InternalExpandableRowsProps<T>;\n  setLastUserAction?: (name: string) => void;\n};\n\nexport function useGroupSelection<T>({\n  ariaLabels,\n  items,\n  rootItems,\n  selectedItems = [],\n  totalItemsCount,\n  trackBy,\n  expandableRows,\n  selectionType,\n  getLoadingStatus,\n  setLastUserAction,\n}: SelectionOptions<T>): SelectionProps<T> {\n  // The name assigned to all controls to combine them in a single group.\n  const selectionControlName = useUniqueId();\n  const [shiftPressed, setShiftPressed] = useState(false);\n  const [lastClickedItem, setLastClickedItem] = useState<null | T>(null);\n\n  if (selectionType !== 'group') {\n    return { isItemSelected: () => false };\n  }\n\n  const getParent = (item: T) => expandableRows.getExpandableItemProps(item).parent;\n  const getChildren = (item: T) => expandableRows.getExpandableItemProps(item).children;\n  const getSelectionStateProps = (item: T) => {\n    const { itemsCount, selectedItemsCount } = expandableRows.getExpandableItemProps(item);\n    return { itemsCount, selectedItemsCount };\n  };\n  const isComplete = (item: null | T) => !getLoadingStatus || getLoadingStatus(item) === 'finished';\n  const treeProps = { rootItems, trackBy, getChildren, isComplete };\n  const selectionTree = new SelectionTree(rootItems, treeProps, expandableRows.groupSelection);\n  const onChange = (groupSelection: TableProps.GroupSelectionState<T>) => {\n    fireNonCancelableEvent(expandableRows.onGroupSelectionChange, { groupSelection });\n    setLastUserAction?.('selection');\n  };\n\n  // Shift-selection helpers.\n  const itemIndexesMap = new Map<T, number>();\n  items.forEach((item, i) => itemIndexesMap.set(getTrackableValue(trackBy, item), i));\n  const getShiftSelectedItems = (item: T): T[] => {\n    const lastClickedItemIndex = lastClickedItem\n      ? itemIndexesMap.get(getTrackableValue(trackBy, lastClickedItem))\n      : undefined;\n    // We use lastClickedItemIndex to determine if filtering/sorting/pagination\n    // made previously selected item invisible, therefore we reset state for shift-select.\n    if (lastClickedItemIndex !== undefined) {\n      const currentItemIndex = itemIndexesMap.get(getTrackableValue(trackBy, item))!;\n      const start = Math.min(currentItemIndex, lastClickedItemIndex);\n      const end = Math.max(currentItemIndex, lastClickedItemIndex);\n      const requestedItems = items.slice(start, end + 1);\n      return lastClickedItemIndex < currentItemIndex ? requestedItems : requestedItems.reverse();\n    }\n    return [item];\n  };\n\n  const handleToggleAll = () => onChange(selectionTree.toggleAll().getState());\n\n  const handleToggleItem = (item: T) => {\n    setLastClickedItem(item);\n    const requestedItems = shiftPressed ? getShiftSelectedItems(item) : [item];\n    const requestedItemParents = requestedItems.reduce((set, item) => set.add(getParent(item)), new Set<null | T>());\n    // Shift-selection is only allowed on items with the same parent.\n    if (requestedItemParents.size === 1) {\n      onChange(selectionTree.toggleSome(requestedItems).getState());\n    }\n  };\n\n  const createLoaderToggleHandle = (item: null | T) => () =>\n    onChange(!item ? selectionTree.invertAll().getState() : selectionTree.invertOne(item).getState());\n\n  return {\n    isItemSelected: selectionTree.isItemSelected,\n    getSelectAllProps: () => ({\n      name: selectionControlName,\n      selectionType: 'multi',\n      disabled: false,\n      checked: selectionTree.isAllItemsSelected(),\n      indeterminate: selectionTree.isAllItemsIndeterminate(),\n      onChange: handleToggleAll,\n      ariaLabel: joinStrings(\n        ariaLabels?.selectionGroupLabel,\n        ariaLabels?.allItemsSelectionLabel?.({\n          selectedItems,\n          itemsCount: expandableRows.totalItemsCount ?? totalItemsCount,\n          selectedItemsCount: expandableRows.totalSelectedItemsCount ?? selectedItems.length,\n        })\n      ),\n    }),\n    getItemSelectionProps: item => ({\n      name: selectionControlName,\n      selectionType: 'multi',\n      disabled: false,\n      checked: selectionTree.isItemSelected(item),\n      indeterminate: selectionTree.isItemIndeterminate(item),\n      onChange: () => handleToggleItem(item),\n      onShiftToggle: value => setShiftPressed(value),\n      ariaLabel: joinStrings(\n        ariaLabels?.selectionGroupLabel,\n        ariaLabels?.itemSelectionLabel?.({ selectedItems, ...getSelectionStateProps(item) }, item)\n      ),\n    }),\n    getLoaderSelectionProps: item => ({\n      name: selectionControlName,\n      selectionType: 'multi',\n      disabled: false,\n      checked: item ? selectionTree.isItemSelected(item) : selectionTree.getState().inverted,\n      indeterminate: false,\n      onChange: createLoaderToggleHandle(item),\n      ariaLabel: joinStrings(\n        ariaLabels?.selectionGroupLabel,\n        ariaLabels?.itemLoaderSelectionLabel?.({ selectedItems }, item)\n      ),\n    }),\n  };\n}\n"]}