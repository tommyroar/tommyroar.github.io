"use strict";
// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = Portal;
const react_1 = require("react");
const react_dom_1 = require("react-dom");
const is_development_js_1 = require("../is-development.js");
const logging_js_1 = require("../logging.js");
function manageDefaultContainer(setState) {
    const newContainer = document.createElement('div');
    document.body.appendChild(newContainer);
    setState(newContainer);
    return () => {
        document.body.removeChild(newContainer);
    };
}
function manageAsyncContainer(getContainer, removeContainer, setState) {
    let newContainer = null;
    const abortController = new AbortController();
    getContainer({ abortSignal: abortController.signal }).then(container => {
        if (abortController.signal.aborted) {
            return;
        }
        newContainer = container;
        setState(container);
    }, error => {
        console.warn('[AwsUi] [portal]: failed to load portal root', error);
    });
    return () => {
        abortController.abort();
        removeContainer(newContainer);
    };
}
/**
 * A safe react portal component that renders to a provided node.
 * If a node isn't provided, it creates one under document.body.
 */
function Portal({ container, getContainer, removeContainer, children }) {
    const [activeContainer, setActiveContainer] = (0, react_1.useState)(container !== null && container !== void 0 ? container : null);
    (0, react_1.useLayoutEffect)(() => {
        if (container) {
            setActiveContainer(container);
            return;
        }
        if (is_development_js_1.isDevelopment) {
            if (getContainer && !removeContainer) {
                (0, logging_js_1.warnOnce)('portal', '`removeContainer` is required when `getContainer` is provided');
            }
            if (!getContainer && removeContainer) {
                (0, logging_js_1.warnOnce)('portal', '`getContainer` is required when `removeContainer` is provided');
            }
        }
        if (getContainer && removeContainer) {
            return manageAsyncContainer(getContainer, removeContainer, setActiveContainer);
        }
        return manageDefaultContainer(setActiveContainer);
    }, [container, getContainer, removeContainer]);
    return activeContainer && (0, react_dom_1.createPortal)(children, activeContainer);
}
